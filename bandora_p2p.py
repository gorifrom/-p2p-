# -*- coding: utf-8 -*-
"""bandora P2P.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/12gZy8iOOc1kTEX3zLcsMR7gKbtzL5okm

# Проект: Риск дефолта (P2P) кредитования Bandora

## Введение :

В этом проекте мы будем проводить моделирование кредитного риска в системах однорангового кредитования Bondora. Данные для исследования были получены из общедоступного набора данных ведущей европейской платформы P2P-кредитования ([**Bondora**](https:/ /www.bondora.com/en/public-reports#dataset-file-format)). Полученные данные представляют собой пул как просроченных, так и недефолтных кредитов за период времени между 1 марта 2009 г. и 
27 января 2020 г. Данные
включает в себя демографическую и финансовую информацию о заемщиках и кредитных транзакциях. При P2P-кредитовании кредиты обычно не обеспечены залогом, и кредиторы стремятся получить более высокую прибыль в качестве компенсации за финансовый риск, который они берут на себя. Кроме того, им необходимо принимать решения в условиях информационной асимметрии, что работает в пользу заемщиков. Чтобы принимать рациональные решения, кредиторы хотят минимизировать риск невыполнения каждого кредитного решения и получить доход, который компенсирует риск.

В этой записной книжке мы предварительно обработаем необработанный набор данных и создадим новый предварительно обработанный CSV-файл, который можно использовать для построения моделей кредитного риска.

### Импортируем библиотеки :
"""

# Commented out IPython magic to ensure Python compatibility.
import numpy as np 
import pandas as pd 
import seaborn as sns 
import plotly.express as px 
import matplotlib.pyplot as plt 
# %matplotlib inline


pd.set_option('display.max_columns', 500)
import warnings
warnings.filterwarnings("ignore")

df=pd.read_csv('LoanData.csv')

df.shape

df['Status'].value_counts()

df.head()

"""| Feature                                | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
|----------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| ActiveLateCategory                     | When a loan is in Principal Debt then it will be categorized by Principal Debt days                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| ActiveLateLastPaymentCategory          | Shows how many days has passed since last payment and categorised if it is overdue                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| ActiveScheduleFirstPaymentReached      | Whether the first payment date has been reached according to the active schedule                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| Age                                    | The age of the borrower when signing the loan application                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| Amount                                 | Amount the borrower received on the Primary Market. This is the principal balance of your purchase from Secondary Market                                                                                                                                                                                                                                                                                                                                                                                            |
| AmountOfPreviousLoansBeforeLoan        | Value of previous loans                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| AppliedAmount                          | The amount borrower applied for originally                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| AuctionBidNumber                       | Unique bid number which is accompanied by Auction number                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| AuctionId                              | A unique number given to all auctions                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| AuctionName                            | Name of the Auction, in newer loans it is defined by the purpose of the loan                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| AuctionNumber                          | Unique auction number which is accompanied by Bid number                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| BidPrincipal                           | On Primary Market BidPrincipal is the amount you made your bid on. On Secondary Market BidPrincipal is the purchase price                                                                                                                                                                                                                                                                                                                                                                                           |
| BidsApi                                | The amount of investment offers made via Api                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| BidsManual                             | The amount of investment offers made manually                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| BidsPortfolioManager                   | The amount of investment offers made by Portfolio Managers                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| BoughtFromResale_Date                  | The time when the investment was purchased from the Secondary Market                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| City                                   | City of the borrower                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| ContractEndDate                        | The date when the loan contract ended                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| Country                                | Residency of the borrower                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| County                                 | County of the borrower                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| CreditScoreEeMini                      | 1000 No previous payments problems 900 Payments problems finished 24-36 months ago 800 Payments problems finished 12-24 months ago 700 Payments problems finished 6-12 months ago 600 Payment problems finished < 6 months ago 500 Active payment problems                                                                                                                                                                                                                                                          |
| CreditScoreEsEquifaxRisk               | Generic score for the loan applicants that do not have active past due operations in ASNEF; a measure of the probability of default one year ahead; the score is given on a 6-grade scale: AAA (“Very low”), AA (“Low”), A (“Average”), B (“Average High”), C (“High”), D (“Very High”).                                                                                                                                                                                                                            |
| CreditScoreEsMicroL                    | A score that is specifically designed for risk classifying subprime borrowers (defined by Equifax as borrowers that do not have access to bank loans); a measure of the probability of default one month ahead; the score is given on a 10-grade scale, from the best score to the worst: M1, M2, M3, M4, M5, M6, M7, M8, M9, M10.                                                                                                                                                                                  |
| CreditScoreFiAsiakasTietoRiskGrade     | Credit Scoring model for Finnish Asiakastieto RL1 Very low risk 01-20 RL2 Low risk 21-40 RL3 Average risk 41-60 RL4 Big risk 61-80 RL5 Huge risk 81-100                                                                                                                                                                                                                                                                                                                                                             |
| CurrentDebtDaysPrimary                 | How long the loan has been in Principal Debt                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| CurrentDebtDaysSecondary               | How long the loan has been in Interest Debt                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| DateOfBirth                            | The date of the borrower's birth                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| DebtOccuredOn                          | The date when Principal Debt occurred                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| DebtOccuredOnForSecondary              | The date when Interest Debt occurred                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| DebtToIncome                           | Ratio of borrower's monthly gross income that goes toward paying loans                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| DefaultDate                            | The date when loan went into defaulted state and collection process was started                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| DesiredDiscountRate                    | Investment being sold at a discount or premium                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| EAD1                                   | Exposure at default, outstanding principal at default                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| EAD2                                   | Exposure at default, loan amount less all payments prior to default                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| Education                              | 1 Primary education 2 Basic education 3 Vocational education 4 Secondary education 5 Higher education                                                                                                                                                                                                                                                                                                                                                                                                               |
| EL_V0                                  | Expected loss calculated by the specified version of Rating model                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| EL_V1                                  | Expected loss calculated by the specified version of Rating model                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| EL_V2                                  | Expected loss calculated by the specified version of Rating model                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| EmploymentDurationCurrentEmployer      | Employment time with the current employer                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| EmploymentPosition                     | Employment position with the current employer                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| EmploymentStatus                       | 1 Unemployed 2 Partially employed 3 Fully employed 4 Self-employed 5 Entrepreneur 6 Retiree                                                                                                                                                                                                                                                                                                                                                                                                                         |
| ExistingLiabilities                    | Borrower's number of existing liabilities                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| ExpectedLoss                           | Expected Loss calculated by the current Rating model                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| ExpectedReturn                         | Expected Return calculated by the current Rating model                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| FirstPaymentDate                       | First payment date according to initial loan schedule                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| FreeCash                               | Discretionary income after monthly liabilities                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| Gender                                 | 0 Male 1 Woman 2 Undefined                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| GracePeriodEnd                         | Date of the end of Grace period                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| GracePeriodStart                       | Date of the beginning of Grace period                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| HomeOwnershipType                      | 0 Homeless 1 Owner 2 Living with parents 3 Tenant, pre-furnished property 4 Tenant, unfurnished property 5 Council house 6 Joint tenant 7 Joint ownership 8 Mortgage 9 Owner with encumbrance 10 Other                                                                                                                                                                                                                                                                                                              |
| IncomeFromChildSupport                 | Borrower's income from alimony payments                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| IncomeFromFamilyAllowance              | Borrower's income from child support                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| IncomeFromLeavePay                     | Borrower's income from paternity leave                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| IncomeFromPension                      | Borrower's income from pension                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| IncomeFromPrincipalEmployer            | Borrower's income from its employer                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| IncomeFromSocialWelfare                | Borrower's income from social support                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| IncomeOther                            | Borrower's income from other sources                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| IncomeTotal                            | Borrower's total income                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| Interest                               | Maximum interest rate accepted in the loan application                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| InterestAndPenaltyBalance              | Unpaid interest and penalties                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| InterestAndPenaltyDebtServicingCost    | Service cost related to the recovery of the debt based on the interest and penalties of the investment                                                                                                                                                                                                                                                                                                                                                                                                              |
| InterestAndPenaltyPaymentsMade         | Note owner received loan transfers earned interest, penalties total amount                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| InterestAndPenaltyWriteOffs            | Interest that was written off on the investment                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| InterestLateAmount                     | Interest debt amount                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| InterestRecovery                       | Interest recovered due to collection process from in debt loans                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| LanguageCode                           | 1 Estonian 2 English 3 Russian 4 Finnish 5 German 6 Spanish 9 Slovakian                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| LastPaymentOn                          | The date of the current last payment received from the borrower                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| LiabilitiesTotal                       | Total monthly liabilities                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| ListedOnUTC                            | Date when the loan application appeared on Primary Market                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| LoanDate                               | Date when the loan was issued                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| LoanDuration                           | Current loan duration in months                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| LoanId                                 | A unique ID given to all loan applications                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| LoanNumber                             | A unique number given to all loan applications                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| LoanStatusActiveFrom                   | How long the current status has been active                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| LossGivenDefault                       | Gives the percentage of outstanding exposure at the time of default that an investor is likely to lose if a loan actually defaults. This means the proportion of funds lost for the investor after all expected recovery and accounting for the time value of the money recovered. In general, LGD parameter is intended to be estimated based on the historical recoveries. However, in new markets where limited experience does not allow us more precise loss given default estimates, a LGD of 90% is assumed. |
| MaritalStatus                          | 1 Married 2 Cohabitant 3 Single 4 Divorced 5 Widow                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| MaturityDate_Last                      | Loan maturity date according to the current payment schedule                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| MaturityDate_Original                  | Loan maturity date according to the original loan schedule                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ModelVersion                           | The version of the Rating model used for issuing the Bondora Rating                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| MonthlyPayment                         | Estimated amount the borrower has to pay every month                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| MonthlyPaymentDay                      | The day of the month the loan payments are scheduled for The actual date is adjusted for weekends and bank holidays (e.g. if 10th is Sunday then the payment will be made on the 11th in that month)                                                                                                                                                                                                                                                                                                                |
| NewCreditCustomer                      | Did the customer have prior credit history in Bondora 0 Customer had at least 3 months of credit history in Bondora 1 No prior credit history in Bondora                                                                                                                                                                                                                                                                                                                                                            |
| NextPaymentDate                        | According to schedule the next date for borrower to make their payment                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| NextPaymentNr                          | According to schedule the number of the next payment                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| NextPaymentSum                         | According to schedule the amount of the next payment                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| NoOfPreviousLoansBeforeLoan            | Number of previous loans                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| note_id                                | A unique ID given to the investments                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| NoteLoanLateChargesPaid                | The amount of late charges the note has received                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| NoteLoanTransfersInterestAmount        | The amount of interest the note has received                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| NoteLoanTransfersMainAmount            | The amount of principal the note has received                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| NrOfDependants                         | Number of children or other dependants                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| NrOfScheduledPayments                  | According to schedule the count of scheduled payments                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| OccupationArea                         | 1 Other 2 Mining 3 Processing 4 Energy 5 Utilities 6 Construction 7 Retail and wholesale 8 Transport and warehousing 9 Hospitality and catering 10 Info and telecom 11 Finance and insurance 12 Real-estate 13 Research 14 Administrative 15 Civil service & military 16 Education 17 Healthcare and social help 18 Art and entertainment 19 Agriculture, forestry and fishing                                                                                                                                      |
| OnSaleSince                            | Time when the investment was added to Secondary Market                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| PenaltyLateAmount                      | Late charges debt amount                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| PlannedInterestPostDefault             | The amount of interest that was planned to be received after the default occurred                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| PlannedInterestTillDate                | According to active schedule the amount of interest the investment should have received                                                                                                                                                                                                                                                                                                                                                                                                                             |
| PlannedPrincipalPostDefault            | The amount of principal that was planned to be received after the default occurred                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| PlannedPrincipalTillDate               | According to active schedule the amount of principal the investment should have received                                                                                                                                                                                                                                                                                                                                                                                                                            |
| PreviousEarlyRepaymentsBeforeLoan      | How much was the early repayment amount before the loan                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| PreviousEarlyRepaymentsCountBeforeLoan | How many times the borrower had repaid early                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| PreviousRepaymentsBeforeLoan           | How much the borrower had repaid before the loan                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| PrincipalBalance                       | Principal that still needs to be paid by the borrower                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| PrincipalDebtServicingCost             | Service cost related to the recovery of the debt based on the principal of the investment                                                                                                                                                                                                                                                                                                                                                                                                                           |
| PrincipalLateAmount                    | Principal debt amount                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| PrincipalOverdueBySchedule             | According to the current schedule, principal that is overdue                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| PrincipalPaymentsMade                  | Note owner received loan transfers principal amount                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| PrincipalRecovery                      | Principal recovered due to collection process from in debt loans                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| PrincipalWriteOffs                     | Principal that was written off on the investment                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| ProbabilityOfDefault                   | Probability of Default, refers to a loan’s probability of default within one year horizon.                                                                                                                                                                                                                                                                                                                                                                                                                          |
| PurchasePrice                          | Investment amount or secondary market purchase price                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| Rating                                 | Bondora Rating issued by the Rating model                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| Rating_V0                              | Bondora Rating issued by version 0 of the Rating model                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| Rating_V1                              | Bondora Rating issued by version 1 of the Rating model                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| Rating_V2                              | Bondora Rating issued by version 2 of the Rating model                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| RecoveryStage                          | Current stage according to the recovery model 1 Collection 2 Recovery 3 Write Off                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| RefinanceLiabilities                   | The total amount of liabilities after refinancing                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| ReScheduledOn                          | The date when the a new schedule was assigned to the borrower                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Restructured                           | The original maturity date of the loan has been increased by more than 60 days                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| SoldInResale_Date                      | The date when the investment was sold on Secondary market                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| SoldInResale_Price                     | The price of the investment that was sold on Secondary market                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| SoldInResale_Principal                 | The principal remaining of the investment that was sold on Secondary market                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| StageActiveSince                       | How long the current recovery stage has been active                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| Status                                 | The current status of the loan application                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| UseOfLoan                              | 0 Loan consolidation 1 Real estate 2 Home improvement 3 Business 4 Education 5 Travel 6 Vehicle 7 Other 8 Health 101 Working capital financing 102 Purchase of machinery equipment 103 Renovation of real estate 104 Accounts receivable financing 105 Acquisition of means of transport 106 Construction finance 107 Acquisition of stocks 108 Acquisition of real estate 109 Guaranteeing obligation 110 Other business All codes in format 1XX are for business loans that are not supported since October 2012  |
| UserName                               | The user name generated by the system for the borrower                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| VerificationType                       | Method used for loan application data verification 0 Not set 1 Income unverified 2 Income unverified, cross-referenced by phone 3 Income verified 4 Income and expenses verified                                                                                                                                                                                                                                                                                                                                    |
| WorkExperience                         | Borrower's overall work experience in years                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| WorseLateCategory                      | Displays the last longest period of days when the loan was in Principal Debt                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| XIRR                                   | XIRR (extended internal rate of return) is a methodology to calculate the net return using the loan issued date and amount, loan repayment dates and amounts and the principal balance according to the original repayment date. All overdue principal payments are written off immediately. No provisions for future losses are made & only received (not accrued or scheduled) interest payments are taken into account.                                                                                          |
"""

total_cells = np.product(df.shape)
total_missing = df.isnull().sum().sum()


percent_missing = (total_missing/total_cells) * 100
print(percent_missing)

"""Мы можем заметить, что почти четверть ячеек в этом наборе данных пусты. На следующем шаге мы более подробно рассмотрим все столбцы с пропущенными значениями и попытаемся выяснить, что с ними происходит."""

DropColList = df.columns[(df.isnull().mean()*100) >= 40].tolist()

df[DropColList].isnull().mean()*100

len(df.columns[(df.isnull().mean()*100) >= 40])

"""Removing all the features which have more than 40% missing values"""

df.drop(columns= DropColList, axis= 1, inplace=True)

df.shape

df.drop(columns=['IncomeFromPrincipalEmployer', 'IncomeFromPension', 'IncomeFromFamilyAllowance', 'IncomeFromSocialWelfare',
                 'IncomeFromLeavePay', 'IncomeFromChildSupport', 'IncomeOther'], inplace = True)

df.drop(columns=['ReportAsOfEOD', 'ListedOnUTC', 'BiddingStartedOn', 'LoanApplicationStartedDate', 'LastPaymentOn',
                 'MonthlyPaymentDay','LoanDate', 'FirstPaymentDate', 'MaturityDate_Original','MaturityDate_Last'], 
        inplace = True)

df.shape

"""#### Создание целевой переменной

Здесь целевая переменная — это переменная, которая помогает нам создать целевую переменную. Причина того, что статус не указан в качестве целевой переменной, заключается в том, что он имеет три уникальных значения: **текущее, просроченное и погашенное**. Функция по умолчанию отсутствует, но есть функция **дата по умолчанию**, которая сообщает нам, когда заемщик не выполнил свои обязательства, значит, на какую дату заемщик не выполнил свои обязательства. Таким образом, мы будем комбинировать функции **Статус** и **Дата по умолчанию** для создания целевой переменной. Причина, по которой мы не можем просто рассматривать «Опоздание» по умолчанию, состоит в том, что в нем также есть некоторые записи, в которых фактический статус «Опоздал», но пользователь никогда не по умолчанию, т. е. дата по умолчанию равна нулю.
Поэтому мы сначала отфильтруем все текущие записи о статусе, потому что они еще не погашены, но являются текущими кредитами. 
"""

df["DefaultDate"] = pd.read_csv('LoanData.csv',low_memory=False).DefaultDate

df.Status.value_counts()

df = df[df.Status != 'Current']

df.Status.value_counts()

df.shape

df.DefaultDate.fillna('NoDefault', inplace = True)

for i in range(len(df.DefaultDate.values)):
    if df.DefaultDate.values[i] != 'NoDefault':
        df.DefaultDate.values[i] = 'Default'

df.DefaultDate.value_counts()

df.drop(columns=['Status'], inplace = True)

df.head()

df.rename(columns={'DefaultDate':'LoanStatus'}, inplace = True)

df.LoanStatus.value_counts()

df['VerificationType'] = df['VerificationType'].astype(object)

for i in range(len(df.VerificationType.values)):
    df.VerificationType.values[i] = str(df.VerificationType.values[i])

df.VerificationType.dtype, type(df.VerificationType.values[0])

df.VerificationType = df.VerificationType.str.replace('0.0', 'Нет данных')
df.VerificationType = df.VerificationType.str.replace('1.0', 'Доход не подтвержден')
df.VerificationType = df.VerificationType.str.replace('2.0', 'Доход не подтвержден, перекрестные ссылки по телефону')
df.VerificationType = df.VerificationType.str.replace('3.0', 'Доход подтвержден')
df.VerificationType = df.VerificationType.str.replace('4.0', 'Доходы и расходы подтверждены')

df.VerificationType.value_counts()

df.Gender.value_counts()

df.Gender.fillna('Undefined', inplace = True)

df['Gender'] = df['Gender'].astype(object)

for i in range(len(df.Gender.values)):
    df.Gender.values[i] = str(df.Gender.values[i])

df.Gender.dtype, type(df.Gender.values[0])

df.Gender = df.Gender.str.replace('0.0', 'Мужской')
df.Gender = df.Gender.str.replace('1.0', 'Женский')
df.Gender = df.Gender.str.replace('2.0', 'Неопределенный')

# Check
df.Gender.value_counts()

df.LanguageCode.value_counts()

# Convert from int types to string first
df.LanguageCode = df.LanguageCode.astype(object)

for i in range(len(df.LanguageCode.values)):
    df.LanguageCode.values[i] = str(df.LanguageCode.values[i])

df.LanguageCode.dtype, type(df.LanguageCode.values[0])

df.LanguageCode.value_counts()

df.LanguageCode = df.LanguageCode.str.replace('7',  'Другой')
df.LanguageCode = df.LanguageCode.str.replace('10', 'Другой')
df.LanguageCode = df.LanguageCode.str.replace('13', 'Другой')
df.LanguageCode = df.LanguageCode.str.replace('15', 'Другой')
df.LanguageCode = df.LanguageCode.str.replace('21', 'Другой')
df.LanguageCode = df.LanguageCode.str.replace('22', 'Другой')
df.LanguageCode = df.LanguageCode.str.replace('1', 'Эстонский')
df.LanguageCode = df.LanguageCode.str.replace('2', 'Английский')
df.LanguageCode = df.LanguageCode.str.replace('3', 'Русский')
df.LanguageCode = df.LanguageCode.str.replace('4', 'Финский')
df.LanguageCode = df.LanguageCode.str.replace('5', 'Немецкий')
df.LanguageCode = df.LanguageCode.str.replace('6', 'Испанский')
df.LanguageCode = df.LanguageCode.str.replace('9', 'Словацкий')

df.LanguageCode.value_counts()

df.UseOfLoan.value_counts()

df.UseOfLoan = df.UseOfLoan.astype(object)

for i in range(len(df.UseOfLoan.values)):
    df.UseOfLoan.values[i] = str(df.UseOfLoan.values[i])

df.UseOfLoan.dtype, type(df.UseOfLoan.values[0])

df.UseOfLoan = df.UseOfLoan.str.replace('102', 'Покупка машинного оборудования')
df.UseOfLoan = df.UseOfLoan.str.replace('110', 'Другой бизнес')
df.UseOfLoan = df.UseOfLoan.str.replace('104', 'Финансирование дебиторской задолженности')
df.UseOfLoan = df.UseOfLoan.str.replace('101', 'Финансирование оборотного капитала')
df.UseOfLoan = df.UseOfLoan.str.replace('107', 'Приобретение акций')
df.UseOfLoan = df.UseOfLoan.str.replace('106', 'Приобретение транспортных средств')
df.UseOfLoan = df.UseOfLoan.str.replace('108', 'Приобретение недвижимости')

df.UseOfLoan = df.UseOfLoan.str.replace('-1',  'Не указано')
df.UseOfLoan = df.UseOfLoan.str.replace('0',   'Кредитная задолженность')
df.UseOfLoan = df.UseOfLoan.str.replace('1',   'Недвижимость')
df.UseOfLoan = df.UseOfLoan.str.replace('2',   'Домовые нужды')
df.UseOfLoan = df.UseOfLoan.str.replace('3',   'Бизнес')
df.UseOfLoan = df.UseOfLoan.str.replace('4',   'Образование')
df.UseOfLoan = df.UseOfLoan.str.replace('5',   'Путешествие')
df.UseOfLoan = df.UseOfLoan.str.replace('6',   'Транспорт')
df.UseOfLoan = df.UseOfLoan.str.replace('7',   'Другое')
df.UseOfLoan = df.UseOfLoan.str.replace('8',   'Здоровье')

df.UseOfLoan.value_counts()

df.Education.fillna('Not Present', inplace = True)

df.Education.value_counts()

df.Education = df.Education.astype(object)

for i in range(len(df.Education.values)):
    df.Education.values[i] = str(df.Education.values[i])

df.Education = df.Education.str.replace('-1.0',  'Не указан')
df.Education = df.Education.str.replace('0.0',   'Не указан')
df.Education = df.Education.str.replace('1.0',   'Начальное образование')
df.Education = df.Education.str.replace('2.0',   'Общее образование')
df.Education = df.Education.str.replace('3.0',   'Проффесионально техническое образование')
df.Education = df.Education.str.replace('4.0',   'Среднее образование')
df.Education = df.Education.str.replace('5.0',   'Высшее образование')

df.Education.value_counts()

"""- Let's handle MaritalStatus column :"""

df.MaritalStatus.value_counts()

df.MaritalStatus.fillna('Not Specified', inplace = True)

df.MaritalStatus = df.MaritalStatus.astype(object)

for i in range(len(df.MaritalStatus.values)):
    df.MaritalStatus.values[i] = str(df.MaritalStatus.values[i])

df.MaritalStatus = df.MaritalStatus.str.replace('-1.0',  'Не указан')
df.MaritalStatus = df.MaritalStatus.str.replace('0.0',   'Не указан')
df.MaritalStatus = df.MaritalStatus.str.replace('1.0',   'Женат')
df.MaritalStatus = df.MaritalStatus.str.replace('2.0',   'Сожитель')
df.MaritalStatus = df.MaritalStatus.str.replace('3.0',   'Одинок')
df.MaritalStatus = df.MaritalStatus.str.replace('4.0',   'В разводе')
df.MaritalStatus = df.MaritalStatus.str.replace('5.0',   'Вдова')

df.MaritalStatus.value_counts()

df.EmploymentStatus.value_counts()

df.EmploymentStatus.fillna('Not present', inplace = True)

df.EmploymentStatus = df.EmploymentStatus.astype(object)

for i in range(len(df.EmploymentStatus.values)):
    df.EmploymentStatus.values[i] = str(df.EmploymentStatus.values[i])

df.EmploymentStatus = df.EmploymentStatus.str.replace('-1.0',  'Не известно')
df.EmploymentStatus = df.EmploymentStatus.str.replace('0.0',   'Безработный')
df.EmploymentStatus = df.EmploymentStatus.str.replace('2.0',   'Частично занятый')
df.EmploymentStatus = df.EmploymentStatus.str.replace('3.0',   'Полностью занятый')
df.EmploymentStatus = df.EmploymentStatus.str.replace('4.0',   'Самозанятый')
df.EmploymentStatus = df.EmploymentStatus.str.replace('5.0',   'Предприниматель')
df.EmploymentStatus = df.EmploymentStatus.str.replace('6.0',   'Пенсионер')

df.EmploymentStatus.value_counts()

df.NewCreditCustomer.value_counts()

df.NewCreditCustomer = df.NewCreditCustomer.astype(object)

for i in range(len(df.NewCreditCustomer.values)):
    df.NewCreditCustomer.values[i] = str(df.NewCreditCustomer.values[i])

"""- Let's handle Restructured column :"""

df.Restructured.value_counts()

df.Restructured = df.Restructured.astype(object)

for i in range(len(df.Restructured.values)):
    df.Restructured.values[i] = str(df.Restructured.values[i])

"""- Let's handle OccupationArea column :"""

df.OccupationArea.fillna('Not present', inplace = True)

df.OccupationArea.value_counts()

df.OccupationArea = df.OccupationArea.astype(object)

for i in range(len(df.OccupationArea.values)):
    df.OccupationArea.values[i] = str(df.OccupationArea.values[i])

df.OccupationArea = df.OccupationArea.str.replace('10.0', 'Инфо и телеком')
df.OccupationArea = df.OccupationArea.str.replace('11.0', 'Финансы и страхование')
df.OccupationArea = df.OccupationArea.str.replace('12.0', 'Недвижимость')
df.OccupationArea = df.OccupationArea.str.replace('13.0', 'Исследование')
df.OccupationArea = df.OccupationArea.str.replace('14.0', 'Администрирование')
df.OccupationArea = df.OccupationArea.str.replace('15.0', 'Военные')
df.OccupationArea = df.OccupationArea.str.replace('16.0', 'Образование')
df.OccupationArea = df.OccupationArea.str.replace('17.0', 'Социальная защита')
df.OccupationArea = df.OccupationArea.str.replace('18.0', 'Искусство')
df.OccupationArea = df.OccupationArea.str.replace('19.0', 'Рыболовство и земледелие')
df.OccupationArea = df.OccupationArea.str.replace('-1.0', 'Нет данных')
df.OccupationArea = df.OccupationArea.str.replace('0.0',  'Нет данных')
df.OccupationArea = df.OccupationArea.str.replace('1.0', 'Другие')
df.OccupationArea = df.OccupationArea.str.replace('2.0', 'Добыча')
df.OccupationArea = df.OccupationArea.str.replace('3.0', 'Процессы')
df.OccupationArea = df.OccupationArea.str.replace('4.0', 'Энергия')
df.OccupationArea = df.OccupationArea.str.replace('5.0', 'Коммуникации')
df.OccupationArea = df.OccupationArea.str.replace('6.0', 'Строительство')
df.OccupationArea = df.OccupationArea.str.replace('7.0', 'Ритейл')
df.OccupationArea = df.OccupationArea.str.replace('8.0', 'Транспорт')
df.OccupationArea = df.OccupationArea.str.replace('9.0',  'Обслуживание')

df.OccupationArea.value_counts()

df.HomeOwnershipType.value_counts()

df.HomeOwnershipType.fillna("Not specified", inplace = True)

df.HomeOwnershipType = df.HomeOwnershipType.astype(object)

for i in range(len(df.HomeOwnershipType.values)):
    df.HomeOwnershipType.values[i] = str(df.HomeOwnershipType.values[i])

df.HomeOwnershipType = df.HomeOwnershipType.str.replace('10.0', 'Другие')
df.HomeOwnershipType = df.HomeOwnershipType.str.replace('-1.0', 'Не определено')
df.HomeOwnershipType = df.HomeOwnershipType.str.replace('0.0',  'Бездомные')
df.HomeOwnershipType = df.HomeOwnershipType.str.replace('1.0', 'Собственники')
df.HomeOwnershipType = df.HomeOwnershipType.str.replace('2.0', 'Живут с родителями')
df.HomeOwnershipType = df.HomeOwnershipType.str.replace('3.0', 'Арендант')
df.HomeOwnershipType = df.HomeOwnershipType.str.replace('4.0', 'Арендант')
df.HomeOwnershipType = df.HomeOwnershipType.str.replace('5.0', 'Общежитие')
df.HomeOwnershipType = df.HomeOwnershipType.str.replace('6.0', 'Совместный арендатор')
df.HomeOwnershipType = df.HomeOwnershipType.str.replace('7.0', 'Совместное владение')
df.HomeOwnershipType = df.HomeOwnershipType.str.replace('8.0', 'Ипотека')
df.HomeOwnershipType = df.HomeOwnershipType.str.replace('9.0',  'Собственник с ограничениями')

df.HomeOwnershipType.value_counts()

df.Rating.value_counts()

df.Rating.fillna('F', inplace = True)

df.Rating.value_counts()

df.CreditScoreEsMicroL.value_counts()

df.CreditScoreEsMicroL.fillna('M', inplace = True)

df.CreditScoreEsMicroL.isnull().sum()

df.EmploymentDurationCurrentEmployer.fillna("Other", inplace = True)

df.EmploymentDurationCurrentEmployer.value_counts()

df.MonthlyPayment.fillna(df.MonthlyPayment.mean(), inplace = True)
df.DebtToIncome.fillna(df.DebtToIncome.mean(), inplace = True)
df.FreeCash.fillna(df.FreeCash.mean(), inplace = True) 
df.PreviousRepaymentsBeforeLoan.fillna(df.PreviousRepaymentsBeforeLoan.mean(), inplace = True)

df.head()

df.select_dtypes([object, bool]).columns

palette_color = sns.color_palette('Set2')
  

plt.pie(df.LoanStatus.value_counts().values, labels = df.LoanStatus.value_counts().index,
        explode=[0, 0] ,colors = palette_color, autopct ='%.1f%%', shadow = True)
plt.title("Процент дефолтных и недефолтных заемщиков")        
  

plt.show()

palette_color = sns.color_palette('Set2')
  

plt.pie(df.Country[df.LoanStatus == 'Default'].value_counts().values, 
        labels = df.Country[df.LoanStatus == 'Default'].value_counts().index,
        explode=[0.1, 0, 0,0] ,colors = palette_color, autopct ='%.1f%%', shadow = True)
plt.title("Percentage of Defaulted to Not Defaulted loans in the dataset")        
  

plt.show()

palette_color = sns.color_palette('Set2')
  

plt.pie(df.Gender[df.LoanStatus == 'Default'].value_counts().values, 
        labels = df.Gender[df.LoanStatus == 'Default'].value_counts().index,
        explode=[0.2, 0.1, 0] ,colors = palette_color, autopct ='%.1f%%', shadow = True)
plt.title("Percentage of each gender of the Deafaulters")        
  

plt.show()

palette_color = sns.color_palette('Set2')
  

plt.pie(df.NewCreditCustomer[df.LoanStatus == 'Default'].value_counts().values, 
        labels = df.NewCreditCustomer[df.LoanStatus == 'Default'].value_counts().index,
        explode=[0, 0] ,colors = palette_color, autopct ='%.1f%%', shadow = False)
plt.title("Процент дефолта новых клиентов")        
  

plt.show()

sns.countplot(y = df.LanguageCode[df.LoanStatus == 'Default'])
plt.title('Language Code distribution of the Defaulters');

sns.countplot(data=df, y = df.Education[df.LoanStatus == 'Default'])
plt.title('Education distribution of defaulters')
plt.ylabel('Education Level');

sns.countplot(data=df, y = df.EmploymentStatus[df.LoanStatus == 'Default'])
plt.title('Employment Status distribution of the Defaulters')
plt.ylabel('Employment Status');

sns.countplot(data=df, y = df.MaritalStatus[df.LoanStatus == 'Default'])
plt.title('Marital Status distribution of the Defaulters')
plt.ylabel('Marital Status');

sns.countplot(data=df, y = df.UseOfLoan[df.LoanStatus == 'Default'])
plt.title('Distribution of Loan purpose of the Defaulters')
plt.ylabel('Loan purpose');

sns.countplot(data=df, y = df.EmploymentDurationCurrentEmployer[df.LoanStatus == 'Default'])
plt.title('Distribution of  Employment Duration with current employer of the Defaulters')
plt.ylabel('Employment Duration ');

sns.countplot(data=df, y = df.OccupationArea[df.LoanStatus == 'Default'])
plt.title('Distribution of Occupation Area of the Defaulters')
plt.ylabel('Occupation Area ');

sns.countplot(data=df, y = df.HomeOwnershipType[df.LoanStatus == 'Default'])
plt.title('Distribution of Home Ownership Type of the Defaulters')
plt.ylabel('Home Ownership Type ');

sns.countplot(data=df, y = df.Rating[df.LoanStatus == 'Default'])
plt.title('Distribution of Ratings of the Defaulters')
plt.ylabel('Rating of the Defaulter');

sns.countplot(data=df, y = df.CreditScoreEsMicroL[df.LoanStatus == 'Default'])
plt.title('Distribution of Credit Score EsMicroL of the Defaulters')
plt.ylabel('Credit Score EsMicroL of the Defaulter');

"""## Числовые признаки :"""

df.select_dtypes(int).columns

df.select_dtypes(float).columns

df.Age[df.LoanStatus=='Default'].describe()

fig, axs = plt.subplots(nrows= 3)

sns.histplot(df.Age[df.LoanStatus=='Default'], ax=axs[0]);
sns.distplot(df.Age[df.LoanStatus=='Default'], ax=axs[1])
sns.boxplot(df.Age[df.LoanStatus=='Default'], ax=axs[2]);

df.MonthlyPayment.describe()

fig, axs = plt.subplots(nrows=2)
sns.distplot(df.MonthlyPayment[df.LoanStatus=='Default'], ax=axs[0], color='blue')
sns.boxplot(df.MonthlyPayment[df.LoanStatus=='Default'], ax=axs[1], color='blue');

df.Amount.describe()

df.AppliedAmount.describe()

fig, axs = plt.subplots(nrows=2, ncols= 2)
sns.distplot(df.Amount[df.LoanStatus=='Default'], ax=axs[0,0], color='blue')
sns.boxplot(df.Amount[df.LoanStatus=='Default'], ax=axs[1,0], color='blue');

sns.distplot(df.AppliedAmount[df.LoanStatus=='Default'], ax=axs[0,1], color='purple')
sns.boxplot(df.AppliedAmount[df.LoanStatus=='Default'], ax=axs[1,1], color='purple');

df.PreviousRepaymentsBeforeLoan.describe()

fig, axs = plt.subplots(nrows=2)
sns.distplot(df.PreviousRepaymentsBeforeLoan[df.LoanStatus=='Default'], ax=axs[0], color='green')
sns.boxplot(df.PreviousRepaymentsBeforeLoan[df.LoanStatus=='Default'], ax=axs[1], color='green');

sns.set(rc = {'figure.figsize':(16,8)})
sns.heatmap(df[df.LoanStatus == 'Default'].corr(), annot = True, fmt='.2g',cmap= 'coolwarm');

sns.scatterplot(x = df.PrincipalBalance, y = df.Amount)
plt.show();

"""### 1. Обработка нулевых значений:

### 2. Обработка выбросов:

###### Каковы критерии для определения выброса?

а - Точка данных, выходящая за пределы 1,5-кратного межквантилевого диапазона выше 3-го квартиля и ниже 1-го квартиля.

b - Точка данных, выходящая за пределы 3 стандартных отклонений. Мы можем использовать Z-оценку, и если Z-оценка выходит за пределы 2 стандартных отклонений.

###### Как мы можем найти выбросы?
- Использование точечных диаграмм.
- Использование коробчатых диаграмм.
- Использование Z-оценки.
- Используя межквартильный диапазон (IQR).
"""

sns.boxplot(df.PreviousRepaymentsBeforeLoan)

df_IQR = df[df.select_dtypes([float, int]).columns].quantile(.75) - df[df.select_dtypes([float, int]).columns].quantile(.25)
df_IQR

df_Max =  df[df.select_dtypes([float, int]).columns].quantile(.75) + (1.5*df_IQR)
df_Min =  df[df.select_dtypes([float, int]).columns].quantile(.25) - (1.5*df_IQR)
df_Max

fig, axs = plt.subplots(nrows=2, ncols= 2)
sns.boxplot(df.Amount[df.LoanStatus=='Default'], ax=axs[0,0], color='blue')
sns.boxplot(df.PreviousRepaymentsBeforeLoan[df.LoanStatus=='Default'], ax=axs[1,0], color='blue');

sns.boxplot(df.FreeCash[df.LoanStatus=='Default'], ax=axs[0,1], color='purple')
sns.boxplot(df.Age[df.LoanStatus=='Default'], ax=axs[1,1], color='purple');

df.select_dtypes([float, int]).columns

col_IQR = df['Age'].quantile(.75) - df['Age'].quantile(.25)
col_Max =  df['Age'].quantile(.75) + (1.5*col_IQR)
col_Max

for column in df.select_dtypes([float, int]).columns :
   
    col_IQR = df[column].quantile(.75) - df[column].quantile(.25)
    col_Max =  df[column].quantile(.75) + (1.5*col_IQR)
    df[column][df[column] > col_Max] =  col_Max

for column in df.select_dtypes([float, int]).columns :
    col_IQR = df[column].quantile(.75) - df[column].quantile(.25)
    col_Min =  df[column].quantile(.25) - (1.5*col_IQR)
    df[column][df[column] < col_Min] =  col_Min

fig, axs = plt.subplots(nrows=2, ncols= 2)
sns.boxplot(df.Amount[df.LoanStatus=='Default'], ax=axs[0,0], color='blue')
sns.boxplot(df.PreviousRepaymentsBeforeLoan[df.LoanStatus=='Default'], ax=axs[1,0], color='blue');

sns.boxplot(df.FreeCash[df.LoanStatus=='Default'], ax=axs[0,1], color='purple')
sns.boxplot(df.Age[df.LoanStatus=='Default'], ax=axs[1,1], color='purple');

"""## 4. Кодирование функций

###### Давайте разделим наши функции на «Целевые» функции и «Независимые функции»:
"""

y = df.LoanStatus
x = df.drop(columns = ['LoanStatus'])

x

from sklearn.preprocessing import LabelEncoder
LE = LabelEncoder()

y = LE.fit_transform(y)

for feature in x.select_dtypes([object, bool]).columns:
    x[feature]= LE.fit_transform(x[feature])

x

y

"""## 3. Выбор функции
Существует много типов и методов выбора признаков, таких как:
1. Фильтр
- Корреляция.
- Порог дисперсии.
- Хи-квадрат.
- Анова.
- Информационная выгода.
2. Обертка
- Рекурсивное устранение признаков (RFE).
3. Встроенный
- Методы регуляризации L1 и L2.

Теперь воспользуемся техникой выбора корреляционного фильтра:

- Высококоррелированные функции будут считаться дублированными функциями при использовании модели машинного обучения, поэтому мы должны удалить их (удалить одну и оставить другую).
"""

sns.set(rc = {'figure.figsize':(16,8)})
sns.heatmap(df[df.LoanStatus == 'Default'].corr(), annot = True, fmt='.2g',cmap= 'coolwarm');

def Correlation(dataset, threshold): 
    correltated_features = set() 
    correlation_matrix = dataset.corr()
    for i in range(len(correlation_matrix.columns)):
        for j in range(i):
            if abs(correlation_matrix.iloc[i, j]) > threshold:
                column_name = correlation_matrix.columns[i]
                correltated_features.add(column_name)
    return correltated_features

Correlation(x, 0.8)

x.drop(columns= ['Amount', 'AmountOfPreviousLoansBeforeLoan', 'NoOfPreviousLoansBeforeLoan'], inplace = True )

"""Now we will use Scikit learn library for feature selection"""

from sklearn.feature_selection import SelectFromModel, SelectKBest, SelectPercentile, mutual_info_classif, f_classif

features = SelectKBest(mutual_info_classif, k=15)

Selected_features =   features.fit_transform(x, y)

x.columns[features.get_support()]

"""## 5. Масштабирование функций

Существует два основных типа масштабирования функций:
- Стандартизация.
- Нормализация.

Мы можем использовать StandardScalar для масштабирования наших данных:
- StandardScaler используется для изменения размера распределения значений, чтобы среднее значение наблюдаемых значений равнялось 0, а стандартное отклонение равнялось 1.
- Значения будут лежать между -1 и 1.
"""

from sklearn.preprocessing import StandardScaler 
from sklearn.preprocessing import MinMaxScaler

Standard_Scalar = StandardScaler()

Selected_features = Standard_Scalar.fit_transform(Selected_features)

Selected_features

"""## 6. Уменьшение размерности признаков

Анализ главных компонентов, или PCA, — это метод уменьшения размерности, который часто используется для уменьшения размерности больших наборов данных путем преобразования большого набора переменных в меньший, который по-прежнему содержит большую часть информации.

Идея PCA проста — уменьшить количество переменных в наборе данных, сохранив при этом как можно больше информации.

Шаги PCA:
- Масштабирование функций.
- Расчет ковариационной матрицы.
- Вычислить собственные векторы и собственные значения ковариационной матрицы, чтобы определить главные компоненты.
- Вектор признаков.
"""

from sklearn.decomposition import PCA

pca = PCA(n_components = 2)

Selected_features_pca =  pca.fit_transform(Selected_features)

Selected_features_pca.shape

Selected_features_pca.shape

plt.figure(figsize=(8, 8))
plt.scatter(Selected_features_pca[:,0], Selected_features_pca[:,1], c = y)
plt.title('Principle component PCA.')
plt.xlabel("First principle compnonent.")
plt.xlabel("Second principle compnonent.")
plt.show();

"""Объясненная дисперсия:
- Объясненная дисперсия — это статистическая мера того, насколько вариации в наборе данных могут быть отнесены к каждому из основных компонентов (собственных векторов), созданных методом анализа основных компонентов (PCA).
- он говорит нам, какая часть общей дисперсии «объясняется» каждым компонентом.
- чем больше дисперсия, объясняемая главным компонентом, тем важнее этот компонент.
- Величина дисперсии, объясняемая каждым направлением, называется «объясненной дисперсией».
- Объясненную дисперсию можно использовать для выбора количества измерений, которые следует сохранить в сокращенном наборе данных. Его также можно использовать для оценки качества модели машинного обучения. В общем, модель с высокой объясненной дисперсией будет иметь хорошую прогностическую силу, в то время как модель с низкой объясненной дисперсией может быть не такой точной.
- Объясненную дисперсию также можно использовать для сравнения различных моделей PCA. Например, если мы сравним две модели, которые уменьшают набор данных с 10 измерений до 2, но одна объясняет 80% дисперсии, а другая объясняет 95% дисперсии, мы бы сказали, что последняя модель лучше представляет данные.

- Example : While you can convert 4-d space to 2-d space, you lose some of variance (information), by using explained_variance_ratio_, you can see the first principle component contains say 72.77% of the variance and the second principle component contains say  23.03% of the variance. Together the two compnenets contain 95.80% of the information.
"""

pca.explained_variance_ratio_

sum(pca.explained_variance_ratio_) * 100

exp_var_pca = pca.explained_variance_ratio_


cum_sum_eigenvalues = np.cumsum(exp_var_pca)

plt.bar(range(0,len(exp_var_pca)), exp_var_pca, alpha=0.5, align='center', label='Individual explained variance')
plt.step(range(0,len(cum_sum_eigenvalues)), cum_sum_eigenvalues, where='mid',label='Cumulative explained variance')
plt.ylabel('Explained variance ratio')
plt.xlabel('Principal component index')
plt.legend(loc='best')
plt.tight_layout()
plt.show()

"""## Построение модели

- Теперь мы разделим наши данные на обучающую и тестовую выборки и подготовим данные для алгоритма машинного обучения.
"""

from sklearn.model_selection import train_test_split
X_train, X_test, y_train, y_test = train_test_split(Selected_features, y, random_state=42, train_size = 0.8)

"""### В нашей работе мы будем использовать две модели:
#### 1- Модель логистической регрессии
#### 2- Случайная модель леса

#### 1. Модель логистической регрессии
"""

from sklearn.linear_model import LogisticRegression

LR = LogisticRegression()

LR.fit(X_train, y_train)

LR.fit(X_train, y_train)

y_predict = LR.predict(X_test)

""" Логистическая регрессия"""

from sklearn.metrics import accuracy_score
from sklearn.metrics import roc_auc_score
from sklearn.metrics import confusion_matrix
from sklearn.metrics import plot_confusion_matrix

accuracy_score(y_test, y_predict)

roc_auc_score(y_test, y_predict)

confusion_matrix(y_test, y_predict)

plot_confusion_matrix(LR, X_test, y_test);

"""#### 2. Случайный лес

- Случайный лес — это контролируемый алгоритм машинного обучения, который широко используется в задачах классификации и регрессии. Он строит деревья решений на разных выборках и принимает большинство голосов за классификацию и среднее значение в случае регрессии.

- Одной из наиболее важных особенностей алгоритма случайного леса является то, что он может обрабатывать набор данных, содержащий непрерывные переменные, как в случае регрессии, так и категориальные переменные, как и в случае классификации. Он дает лучшие результаты для задач классификации.
"""

from sklearn.model_selection import train_test_split
X_train, X_test, y_train, y_test = train_test_split(Selected_features, y, random_state=42, train_size = 0.8)

from sklearn.ensemble import RandomForestClassifier

RFC = RandomForestClassifier()

RFC.fit(X_train, y_train)

y_predict = RFC.predict(X_test)

"""##### Случайный лес"""

accuracy_score(y_test, y_predict)

roc_auc_score(y_test, y_predict)

confusion_matrix(y_test, y_predict)

plot_confusion_matrix(RFC, X_test, y_test);

